<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <title>ã°ã‚ã°ã¨è©±ã—ã¦ã¿ã‚ˆ</title>
  <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* --- ãƒ‡ã‚¶ã‚¤ãƒ³å®šç¾© --- */
    :root {
      --primary-color: #4a90e2;
      /* Softer blue */
      --accent-color: #9b59b6;
      /* Purple for liquid feel */
      --danger-color: #ff6b6b;
      --glass-bg: rgba(255, 255, 255, 0.65);
      --glass-border: 1px solid rgba(255, 255, 255, 0.4);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      --glass-blur: blur(12px);
      --text-color: #2c3e50;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      color: var(--text-color);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    @keyframes gradientBG {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    /* Liquid Background Shapes */
    body::before,
    body::after {
      content: '';
      position: absolute;
      border-radius: 50%;
      z-index: -1;
      filter: blur(60px);
      opacity: 0.6;
    }

    body::before {
      width: 400px;
      height: 400px;
      background: #a1c4fd;
      top: -100px;
      left: -100px;
      animation: float 8s infinite alternate;
    }

    body::after {
      width: 500px;
      height: 500px;
      background: #c2e9fb;
      bottom: -100px;
      right: -100px;
      animation: float 10s infinite alternate-reverse;
    }

    @keyframes float {
      from {
        transform: translate(0, 0);
      }

      to {
        transform: translate(30px, 30px);
      }
    }

    .sidebar {
      width: 320px;
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      border-right: var(--glass-border);
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-shadow: 5px 0 15px rgba(0, 0, 0, 0.05);
      z-index: 10;
      transition: transform 0.3s ease;
    }

    /* ã‚¤ãƒ©ã‚¤ãƒ©æ¼”å‡º (ç”»é¢ä¾µé£Ÿ) */
    #stress-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, transparent 30%, rgba(200, 0, 0, 0.95) 150%);
      pointer-events: none;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.2s ease;
      mix-blend-mode: multiply;
    }

    /* è­¦å‘Šãƒˆãƒ¼ã‚¹ãƒˆ */
    #stress-warning {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      background: rgba(231, 76, 60, 0.95);
      color: white;
      padding: 40px 60px;
      border-radius: 20px;
      font-weight: 900;
      font-size: 2rem;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      opacity: 0;
      pointer-events: none;
      z-index: 2100;
      text-align: center;
      transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #stress-warning.show {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }

    /* ã¡ã‚‡ã£ã¨å¾…ã¦ã„ï¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    #wait-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      backdrop-filter: blur(8px);
    }

    .wait-text {
      font-size: 6rem;
      color: white;
      font-weight: 900;
      text-shadow: 5px 5px 0 #c0392b, -2px -2px 0 #e74c3c;
      transform: rotate(-5deg);
      border: 10px solid white;
      padding: 20px 60px;
      background: #e74c3c;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      animation: stamp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .wait-sub {
      color: white;
      margin-top: 30px;
      font-size: 1.5rem;
      font-weight: bold;
      letter-spacing: 0.1em;
    }

    @keyframes stamp {
      0% {
        transform: scale(3) rotate(10deg);
        opacity: 0;
      }

      100% {
        transform: scale(1) rotate(-5deg);
        opacity: 1;
      }
    }

    .svg-icon {
      width: 20px;
      height: 20px;
      fill: currentColor;
      vertical-align: text-bottom;
    }

    @keyframes popIn {
      0% {
        transform: scale(0.95);
        opacity: 0;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes slideIn {
      from {
        transform: translateX(-10px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* ãƒœã‚¿ãƒ³ */
    .btn {
      cursor: pointer;
      border: none;
      outline: none;
      transition: 0.3s;
      font-weight: bold;
      border-radius: 50px;
      padding: 10px 20px;
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(118, 75, 162, 0.6);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    .btn-outline {
      background: #fff;
      border: 2px solid #ddd;
      color: #555;
    }

    .btn-outline:hover {
      border-color: var(--accent-color);
      color: var(--accent-color);
      background: #fdfdfd;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 94, 98, 0.4);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 94, 98, 0.6);
    }

    /* ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    #page-landing,
    #page-result,
    #page-analysis {
      flex-direction: column;
      align-items: center;
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
      overflow-y: auto;
    }

    #page-landing {
      display: flex;
      z-index: 100;
      background: linear-gradient(120deg, #f6d365 0%, #fda085 100%);
      justify-content: center;
    }

    #page-main {
      display: none;
      height: 100%;
      width: 100%;
      background: #fdfbfb;
      position: relative;
    }

    #page-result,
    #page-analysis {
      display: none;
      z-index: 150;
      background: #f8f9fa;
      padding-bottom: 100px;
      justify-content: flex-start;
      padding-top: 60px;
    }

    .landing-card {
      background: rgba(255, 255, 255, 0.98);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
      width: 900px;
      max-width: 95%;
      text-align: center;
      animation: popIn 0.5s cubic-bezier(0.19, 1, 0.22, 1);
      margin: 20px auto;
    }

    .input-name {
      width: 100%;
      padding: 12px;
      margin-bottom: 25px;
      border: 2px solid #eee;
      border-radius: 10px;
      font-size: 1.1rem;
      text-align: center;
      background: #fafafa;
    }

    .input-name:focus {
      border-color: #fda085;
      outline: none;
      background: #fff;
    }

    .scenario-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    }

    .scenario-card {
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    .scenario-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }

    .scenario-card.selected {
      border-color: #fda085;
      background: #fff8f5;
      transform: scale(1.02);
    }

    .scenario-card img {
      width: 100%;
      height: 90px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .scenario-name {
      font-weight: bold;
      font-size: 0.85rem;
      color: #444;
    }

    /* ãƒ›ãƒãƒ¼èª¬æ˜ (ã‚«ãƒ¼ãƒ‰å†…ã«åã‚ã‚‹ä¿®æ­£) */
    .scenario-desc-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 165, 2, 0.98);
      color: white;
      padding: 10px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 0.75rem;
      line-height: 1.4;
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: 10px;
      pointer-events: none;
      white-space: normal;
      word-break: break-word;
      /* ã¯ã¿å‡ºã—é˜²æ­¢ */
    }

    .scenario-card:hover .scenario-desc-overlay {
      opacity: 1;
    }

    .sidebar {
      width: 320px;
      min-width: 320px;
      background: #fff;
      border-right: 1px solid #f0f0f0;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow-y: hidden;
      z-index: 10;
      transition: margin-left 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .sidebar.hidden {
      margin-left: -360px;
    }

    #toggle-sidebar-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 20;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      color: #555;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .mini-scene-switcher {
      background: #333;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 10px;
      position: relative;
      height: 120px;
      flex-shrink: 0;
    }

    .mini-scene-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.85;
      transition: 0.3s;
    }

    .mini-scene-overlay {
      position: absolute;
      bottom: 0;
      width: 100%;
      padding: 8px;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
    }

    .mini-nav-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      cursor: pointer;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* ã‚·ãƒŠãƒªã‚ªèª¬æ˜æ–‡ (ä¸­å¤®æƒãˆ) */
    .scenario-description {
      font-size: 0.75rem;
      color: #555;
      margin-bottom: 20px;
      padding: 12px;
      background: #fff8e1;
      border-radius: 8px;
      line-height: 1.5;
      border: 1px solid #ffe0b2;
      text-align: center;
    }

    .control-area {
      flex: 1;
      overflow-y: auto;
      padding-right: 5px;
      padding-bottom: 20px;
    }

    h3 {
      color: var(--accent-color);
      margin-bottom: 15px;
      border-bottom: 2px solid rgba(0, 0, 0, 0.05);
      padding-bottom: 8px;
      font-size: 1rem;
    }

    .control-group {
      margin-bottom: 20px;
      position: relative;
    }

    .control-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-weight: bold;
      font-size: 0.85rem;
      color: #555;
    }

    .val-display {
      color: var(--accent-color);
      font-family: monospace;
    }

    input[type=range] {
      width: 100%;
      accent-color: var(--accent-color);
      cursor: pointer;
      height: 6px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 5px;
      appearance: none;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent-color);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }

    /* Meter UI for Indirection */
    .meter-bar-wrapper {
      width: 100%;
      padding: 5px 0;
    }

    .meter-bar {
      width: 100%;
      height: 10px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 5px;
      overflow: hidden;
    }

    .meter-fill {
      height: 100%;
      background: linear-gradient(90deg, #a18cd1 0%, #fbc2eb 100%);
      width: 50%;
      border-radius: 5px;
      transition: width 0.3s ease;
    }

    /* ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ›ãƒãƒ¼èª¬æ˜ (Glass) */
    .param-desc {
      position: absolute;
      bottom: 45px;
      left: 50%;
      transform: translateX(-50%);
      width: 180px;
      font-size: 0.75rem;
      color: #333;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(8px);
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.6);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s, bottom 0.2s;
      z-index: 1000;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      font-weight: bold;
    }

    .control-group:hover .param-desc {
      opacity: 1;
      bottom: 55px;
    }

    .param-desc::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -6px;
      border-width: 6px;
      border-style: solid;
      border-color: rgba(255, 255, 255, 0.95) transparent transparent transparent;
    }

    .master-control {
      background: rgba(239, 246, 255, 0.5);
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(219, 234, 254, 0.5);
      margin-bottom: 20px;
      box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.5);
    }

    .sub-controls {
      padding-left: 10px;
      border-left: 3px solid #dbeafe;
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-left: 4px;
    }

    .preset-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .preset-btn {
      font-size: 0.75rem;
      padding: 5px 10px;
      border: 1px solid #ddd;
      border-radius: 20px;
      background: white;
      cursor: pointer;
      transition: 0.2s;
    }

    .preset-btn:hover {
      background: #eef2ff;
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .preset-area {
      margin-top: 30px;
      border-top: 2px solid #f0f0f0;
      padding-top: 20px;
    }

    .preset-item {
      background: #fff;
      border: 1px solid #eee;
      padding: 8px 12px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .preset-name {
      font-weight: bold;
      font-size: 0.85rem;
      color: #333;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: transparent;
      position: relative;
    }

    .top-bar {
      position: absolute;
      top: 0;
      right: 0;
      padding: 15px;
      z-index: 20;
    }

    .visual-area {
      flex: 1;
      margin: 15px;
      border-radius: 20px;
      overflow: hidden;
      position: relative;
      background: rgba(0, 0, 0, 0.8);
      box-shadow: var(--glass-shadow);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #main-display-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .guide-board {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(248, 243, 212, 0.9);
      backdrop-filter: blur(4px);
      border: 2px solid #d4a373;
      border-radius: 8px;
      padding: 10px 15px;
      font-size: 0.8rem;
      color: #5d4037;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .key-badge {
      background: #fff;
      border: 1px solid #ccc;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
    }

    .chat-area {
      height: 40%;
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      display: flex;
      flex-direction: column;
      border-top: var(--glass-border);
      z-index: 5;
      margin: 0 15px 15px 15px;
      border-radius: 20px;
      box-shadow: var(--glass-shadow);
    }

    .chat-log {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .msg {
      max-width: 75%;
      padding: 12px 18px;
      border-radius: 18px;
      line-height: 1.6;
      font-size: 0.95rem;
      position: relative;
      word-wrap: break-word;
      animation: slideIn 0.3s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
    }

    .msg.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 2px;
      box-shadow: 0 4px 10px rgba(118, 75, 162, 0.3);
    }

    .msg.ai {
      align-self: flex-start;
      background: #fff;
      color: #333;
      border-bottom-left-radius: 2px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .msg.system {
      align-self: center;
      background: rgba(255, 243, 224, 0.9);
      color: #e65100;
      font-size: 0.8rem;
      padding: 5px 15px;
      border-radius: 20px;
      border: 1px solid #ffe0b2;
      margin: 10px 0;
      text-align: center;
    }

    .msg.thinking {
      align-self: flex-start;
      background: #f3f4f6;
      color: #aaa;
      font-style: italic;
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 10px 15px;
    }

    .dot {
      width: 6px;
      height: 6px;
      background: #bbb;
      border-radius: 50%;
      animation: pulse 1s infinite;
    }

    .dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    .input-area {
      padding: 15px 20px;
      background: transparent;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #text-input {
      flex: 1;
      padding: 12px 20px;
      border-radius: 50px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      outline: none;
      font-size: 1rem;
      background: rgba(255, 255, 255, 0.8);
      transition: 0.3s;
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    #text-input:focus {
      background: #fff;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(155, 89, 182, 0.2);
    }

    .icon-btn {
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.8);
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      color: #555;
      transition: 0.2s;
      backdrop-filter: blur(4px);
    }

    .icon-btn:hover {
      background: #fff;
      color: var(--accent-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .icon-btn.active {
      background: #ffebee;
      color: #e74c3c;
      box-shadow: 0 0 10px rgba(231, 76, 60, 0.3);
    }

    /* çµ‚äº†ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #end-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 200;
      justify-content: center;
      align-items: center;
      animation: popIn 0.3s;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      width: 500px;
      max-width: 90%;
      text-align: center;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
    }

    .modal-title {
      font-size: 1.4rem;
      color: #e74c3c;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .modal-text {
      color: #555;
      margin-bottom: 20px;
      line-height: 1.6;
      font-size: 0.95rem;
    }

    .modal-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #eee;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    /* VAS (Glass Texture & Complex Morphing) */
    .vas-container {
      text-align: center;
      margin-bottom: 30px;
      padding: 30px;
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      border: var(--glass-border);
      padding: 40px;
      border-radius: 20px;
      box-shadow: var(--glass-shadow);
    }

    .vas-shape-wrapper {
      width: 250px;
      height: 250px;
      margin: 0 auto 30px auto;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      filter: drop-shadow(0 20px 40px rgba(0, 0, 0, 0.15));
    }

    /* å¤šå±¤æ§‹é€ ã®VASã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ */
    @keyframes ripple {
      0% {
        transform: scale(1.0);
        opacity: 0.6;
      }

      100% {
        transform: scale(1.4);
        opacity: 0;
      }
    }

    .vas-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      /* border-radius removed here, handled by JS clip-path */
      transition: background 0.5s ease;
      mix-blend-mode: normal;
      /* Changed from hard-light for smoother look */
    }

    #vas-shape-layer2 {
      animation: ripple 3s infinite linear;
      /* transform-origin handled by animation, ensuring it expands from center */
    }

    .vas-layer::after {
      /* Removed inner light reflection to keep shape clean */
      content: none;
    }

    .vas-slider-wrapper {
      position: relative;
      width: 80%;
      margin: 20px auto;
    }

    .vas-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: #888;
      margin-top: 10px;
      font-weight: bold;
    }

    .emotion-tags {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      /* Reduced gap */
      margin-top: 20px;
      max-width: 100%;
    }

    .emotion-tag {
      padding: 6px 12px;
      /* Reduced padding */
      border-radius: 16px;
      border: 1px solid #ddd;
      cursor: pointer;
      background: #fff;
      font-size: 0.85rem;
      /* Smaller font */
      transition: all 0.2s;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
      flex: 0 1 auto;
      /* Allow shrink */
    }

    .emotion-tag:hover {
      transform: translateY(-2px);
    }

    .emotion-tag.selected {
      background: #e0e7ff;
      border-color: var(--accent-color);
      color: var(--accent-color);
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(37, 117, 252, 0.2);
    }

    /* æŒ¯ã‚Šè¿”ã‚Šãƒ»åˆ†æç”»é¢ */
    .review-container {
      max-width: 800px;
      width: 95%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .chat-review-list {
      background: white;
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.03);
    }

    .review-item {
      display: flex;
      gap: 12px;
      padding: 15px;
      border-bottom: 1px solid #f5f5f5;
      align-items: flex-start;
      position: relative;
    }

    .event-log {
      width: 100%;
      text-align: center;
      margin: 10px 0;
      font-size: 0.85rem;
      font-weight: bold;
      padding: 8px;
      border-radius: 8px;
    }

    .event-log.wait {
      color: #d35400;
      background: #fbeee6;
      border-left: 4px solid #d35400;
    }

    .event-log.stress {
      color: #c0392b;
      background: #f9e7e7;
      border-left: 4px solid #c0392b;
    }

    .review-checkbox {
      margin-top: 5px;
      transform: scale(1.5);
      cursor: pointer;
      accent-color: var(--danger-color);
    }

    .review-role {
      font-size: 0.8rem;
      color: #888;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .review-text {
      font-size: 1rem;
      color: #333;
      line-height: 1.6;
    }

    .param-tag {
      display: none;
    }

    /* åˆ†æçµæœç”»é¢ */
    /* åˆ†æçµæœç”»é¢ (Liquid Glass Update) */
    .analysis-box {
      background: white;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      border: 2px solid #eef2ff;
      max-width: 1000px;
      width: 95%;
      margin: 20px auto;
    }

    .analysis-title {
      color: var(--accent-color);
      font-size: 1.6rem;
      margin-bottom: 25px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      padding-bottom: 20px;
    }

    .analysis-content {
      line-height: 1.8;
      color: #444;
      font-size: 1rem;
      text-align: left;
    }

    /* Ranking Table - Wide & Interactive */
    .ranking-table-container {
      width: 100%;
      box-sizing: border-box;
      /* Ensure padding doesn't overflow width */
      overflow-x: auto;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 12px;
      padding: 0;
      box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-top: 20px;
      max-height: 400px;
    }

    .ranking-table {
      width: 100%;
      border-collapse: collapse;
      /* min-width: 600px; - Removed to fit simpler layout if possible, or keep if needed */
    }

    .ranking-table th,
    .ranking-table td {
      padding: 10px;
      /* Reduced padding */
      text-align: left;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      font-size: 0.85rem;
      /* Reduced font size */
      white-space: nowrap;
      /* Prevent wrap */
    }

    .ranking-table th {
      color: #555;
      font-weight: bold;
      background: rgba(255, 255, 255, 0.8);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .ranking-table tr {
      cursor: pointer;
      transition: background 0.2s;
    }

    .ranking-table tr:hover {
      background: rgba(255, 255, 255, 0.8);
    }

    .ranking-table tr.selected {
      background: rgba(155, 89, 182, 0.2);
    }

    .user-highlight {
      background-color: rgba(74, 144, 226, 0.15);
      font-weight: bold;
      border-left: 4px solid var(--primary-color);
    }

    /* New Chart & Insight Area */
    .analysis-flex {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      margin-top: 30px;
    }

    .chart-section {
      flex: 1;
      min-width: 300px;
      background: #fff;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    .insight-section {
      flex: 1;
      min-width: 300px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      justify-content: center;
    }

    .insight-card {
      background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .insight-card::before {
      content: "ğŸ’¡ Insight";
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 0.8rem;
      font-weight: bold;
      opacity: 0.8;
      letter-spacing: 1px;
    }

    .insight-text {
      font-size: 1.1rem;
      font-weight: bold;
      margin-top: 10px;
      line-height: 1.5;
    }

    .insight-sub {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-top: 5px;
    }

    .capacity-bar-container {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
    }

    .capacity-bar-bg {
      flex: 1;
      height: 8px;
      background: #eee;
      border-radius: 4px;
      overflow: hidden;
    }

    .capacity-bar-fill {
      height: 100%;
      width: 0;
      transition: width 1s ease-out;
      border-radius: 4px;
    }

    .capacity-val {
      font-size: 0.85rem;
      font-weight: bold;
      width: 30px;
      text-align: right;
    }

    /* åˆ†æä¸­ãƒ­ãƒ¼ãƒ€ãƒ¼ (Interactive) */
    .loading-anim {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      padding: 60px;
      text-align: center;
      margin-top: 40px;
    }

    .vas-shape-wrapper {
      position: relative;
      width: 200px;
      /* Reduced visual size to prevent overlap */
      height: 200px;
      margin: 20px auto;
      transform: rotate(0deg);
      /* Fixed to horizontal (0deg) */
      /* Symmetry adjustment */
    }

    .loader-wrapper {
      position: relative;
      width: 120px;
      height: 120px;
    }

    .pulse-circle {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);
      opacity: 0.6;
      animation: pulseLoader 2s infinite ease-in-out;
    }

    .pulse-circle:nth-child(2) {
      animation-delay: 1s;
    }

    .loader-core {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      background: white;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      font-size: 1.5rem;
      animation: spinCore 3s linear infinite;
    }

    @keyframes pulseLoader {
      0% {
        transform: scale(0.8);
        opacity: 0.8;
      }

      100% {
        transform: scale(2.0);
        opacity: 0;
      }
    }

    @keyframes spinCore {
      0% {
        transform: translate(-50%, -50%) rotate(0deg);
      }

      100% {
        transform: translate(-50%, -50%) rotate(360deg);
      }
    }
  </style>

</head>

<body>

  <div id="stress-overlay"></div>

  <div id="stress-warning">
    <div style="font-size:3rem; margin-bottom:10px;">âš ï¸</div>
    <div>ã¡ã‚‡ã£ã¨è½ã¡ç€ã„ã¦ï¼</div>
    <div style="font-size:1.2rem; font-weight:normal;">ã°ã‚ã°ã®è©±ã‚’æœ€å¾Œã¾ã§èã„ã¦ã‚ã’ã¦</div>
  </div>

  <div id="wait-overlay">
    <div class="wait-text">ã¡ã‚‡ã£ã¨å¾…ã¦ã„ï¼</div>
    <div class="wait-sub">ä¸€å‘¼å¸ã—ã¦ã‹ã‚‰å†é–‹ã—ã¾ã—ã‚‡ã†</div>
    <div style="margin-top:10px; color:white; font-size:0.9rem;">(Enterã‚­ãƒ¼ã§å†é–‹)</div>
  </div>

  <div id="page-landing" style="background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px);">
    <div class="landing-card"
      style="background: rgba(255,255,255,0.8); box-shadow: 0 20px 50px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.6);">
      <h2 style="color:#e65100;">ã°ã‚ã°ã¨è©±ã—ã¦ã¿ã‚ˆ</h2>
      <p style="color:#666; margin-bottom:20px;">ãŠè©±ã‚’å§‹ã‚ã‚‹å‰ã«ãŠåå‰ã¨ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
      <input type="text" id="user-name" class="input-name" placeholder="ã‚ãªãŸã®ãŠåå‰">
      <div style="text-align:left; font-weight:bold; color:#555; margin-bottom:10px;">ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³é¸æŠ</div>
      <div class="scenario-grid">
        <div class="scenario-card selected" onclick="selectInitialScenario(0)">
          <img src="/public/image/granma_kotatsu.jpg" alt="å®¶">
          <div class="scenario-name">ç¥–æ¯ã®å®¶</div>
          <div class="scenario-desc-overlay">ã‚ãªãŸã¯ä¹…ã—ã¶ã‚Šã«ç¥–æ¯ã®å®¶ã«è¨ªã‚Œã¾ã™ã€‚å­«ã¨ã—ã¦è¿‘æ³å ±å‘Šã¨ã€æœ€è¿‘ã®ãŠã°ã‚ã¡ã‚ƒã‚“ã®æ§˜å­ã‚’èã„ã¦ã¿ã¾ã—ã‚‡ã†ï¼</div>
        </div>
        <div class="scenario-card" onclick="selectInitialScenario(1)">
          <img src="/public/image/granma_dayservice.jpg" alt="ãƒ‡ã‚¤">
          <div class="scenario-name">ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹</div>
          <div class="scenario-desc-overlay">ã‚ãªãŸã¯å¤§å­¦ã®å®Ÿç¿’ã§ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ã¦ã„ã¾ã™ã€‚é€±ã«ï¼’å›é€šã£ã¦ã„ã‚‹éš£ã®å¸­ã®å’Œå­ã•ã‚“ãŒä½•ã‹ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚è©±ã—ã‹ã‘ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</div>
        </div>
        <div class="scenario-card" onclick="selectInitialScenario(2)">
          <img src="/public/image/granma_station.jpg" alt="é§…">
          <div class="scenario-name">é§…ã®æ”¹æœ­å‘¨è¾º</div>
          <div class="scenario-desc-overlay">é§…ã§å›°ã£ã¦ã„ã‚‹ãŠã°ã‚ã•ã‚“ã‚’è¦‹ã‹ã‘ã¾ã—ãŸã€‚å„ªã—ãå£°ã‚’ã‹ã‘ã€ç›®çš„åœ°ã¾ã§ã®æ¡ˆå†…ã‚’æ‰‹ä¼ã£ã¦ã‚ã’ã¾ã—ã‚‡ã†ã€‚</div>
        </div>
        <div class="scenario-card" onclick="selectInitialScenario(3)">
          <img src="/public/image/granpa_home.jpg" alt="è€äººãƒ›ãƒ¼ãƒ ">
          <div class="scenario-name">è€äººãƒ›ãƒ¼ãƒ </div>
          <div class="scenario-desc-overlay">å®Ÿç¿’ã§è¨ªã‚ŒãŸè€äººãƒ›ãƒ¼ãƒ ã€‚ä¸€äººé™ã‹ã«éã”ã™æ¸…ã•ã‚“ã€‚å£æ•°ã¯å°‘ãªã„ã§ã™ãŒã€è¶£å‘³ã‚„æ˜”ã®è©±ã‚’èã„ã¦ä¼šè©±ã‚’åºƒã’ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</div>
        </div>
      </div>
      <button class="btn btn-primary" style="width:100%; font-size:1.2rem; padding:15px;"
        onclick="startWorkshop()">ã°ã‚ã°ã¨è©±ãã†ï¼</button>
    </div>
  </div>

  <div id="page-main">
    <button id="toggle-sidebar-btn" onclick="toggleSidebar()">
      <svg class="svg-icon" viewBox="0 0 24 24">
        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
      </svg> è¨­å®š
    </button>

    <div class="top-bar">
      <button class="btn btn-danger btn-sm" onclick="showEndModal()">
        <svg class="svg-icon" viewBox="0 0 24 24">
          <path
            d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z" />
        </svg> ä¼šè©±ã‚’çµ‚äº†ã™ã‚‹
      </button>
    </div>

    <div class="sidebar" id="sidebar-panel">
      <div class="mini-scene-switcher">
        <img id="mini-scene-img" src="" class="mini-scene-img">
        <div class="mini-scene-overlay">
          <button class="mini-nav-btn" onclick="changeScenario(-1)"><svg class="svg-icon" viewBox="0 0 24 24">
              <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
            </svg></button>
          <span id="mini-scene-title" style="font-weight:bold; color:white;">ç¥–æ¯ã®å®¶</span>
          <button class="mini-nav-btn" onclick="changeScenario(1)"><svg class="svg-icon" viewBox="0 0 24 24">
              <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
            </svg></button>
        </div>
      </div>

      <div id="scenario-desc-area" class="scenario-description"></div>

      <div class="control-area">
        <h3>ğŸ§  ã°ã‚ã°ã®é ­ã®ä¸­</h3>
        <!-- Dynamic Image Text moved to header -->

        <div class="control-group master-control"
          style="position: sticky; top: 0; z-index: 100; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); border-bottom: 1px solid #eee; padding-top: 10px; padding-bottom: 15px; margin-bottom: 20px;">
          <div class="control-header"><span>â˜… è©±ã®é•·ã•ãƒ»è¿‚é ã•</span><span id="val_uen" class="val-display">5</span></div>
          <div class="meter-bar-wrapper">
            <div class="meter-bar">
              <div id="uen_meter" class="meter-fill" style="width: 50%;"></div>
            </div>
          </div>
          <div id="param-dynamic-image" class="param-dynamic-image"
            style="margin-top:10px; font-weight:normal; font-size:0.85rem; padding:8px; border:none; background:rgba(240,248,255,0.7); box-shadow:none;">
            ã“ã“ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
          </div>
        </div>
        <div class="sub-controls">
          <div class="control-group">
            <div class="control-header"><span>1. ç‰©å¿˜ã‚Œ</span><span id="val_forget" class="val-display">5</span></div>
            <input type="range" id="forget_ratio" class="sub-slider" min="0" max="10" step="1" value="5">
            <div class="param-desc">ç›´å‰ã®ä¼šè©±ã®å†…å®¹ã‚„ã‚ãªãŸã®åå‰ãªã©ã‚’å¿˜ã‚Œã¾ã™ã€‚</div>
          </div>
          <div class="control-group">
            <div class="control-header"><span>2. ç¹°ã‚Šè¿”ã—</span><span id="val_repeat" class="val-display">5</span></div>
            <input type="range" id="repeat_ratio" class="sub-slider" min="0" max="10" step="1" value="5">
            <div class="param-desc">åŒã˜å†…å®¹ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚</div>
          </div>
          <div class="control-group">
            <div class="control-header"><span>3. è¨€è‘‰ã®è©°ã¾ã‚Š</span><span id="val_kosoado" class="val-display">5</span></div>
            <input type="range" id="kosoado_ratio" class="sub-slider" min="0" max="10" step="1" value="5">
            <div class="param-desc">åå‰ãŒå‡ºãšã€Œã‚ã‚Œã€ã€Œãã‚Œã€ãŒå¢—ãˆã¾ã™ã€‚</div>
          </div>
          <div class="control-group">
            <div class="control-header"><span>4. è©±ã®å›ã‚Šãã©ã•</span><span id="val_summary" class="val-display">5</span></div>
            <input type="range" id="summary_skill" class="sub-slider" min="0" max="10" step="1" value="5">
            <div class="param-desc">çŠ¶æ³èª¬æ˜ãŒç¶šãã€çµè«–ã«ãªã‹ãªã‹è¾¿ã‚Šç€ãã¾ã›ã‚“ã€‚</div>
          </div>
          <div class="control-group">
            <div class="control-header"><span>5. è©±ã®é€£æƒ³åŠ›</span><span id="val_association" class="val-display">5</span>
            </div><input type="range" id="association_skill" class="sub-slider" min="0" max="10" step="1" value="5">
            <div class="param-desc">é€£æƒ³ã‚²ãƒ¼ãƒ ã®ã‚ˆã†ã«ã€è©±é¡ŒãŒå¤‰ã‚ã‚Šç¶šã‘ã¾ã™ã€‚</div>
          </div>
        </div>
        <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
        <!-- Filler param removed per Round 12 -->
        <div class="control-group">
          <div class="control-header"><span>è©±é€Ÿ</span><span id="val_speed" class="val-display">1.0</span></div><input
            type="range" id="speech_rate" min="0.5" max="1.5" step="0.1" value="1.0">
          <div class="param-desc">èãå–ã‚Šã‚„ã™ã•ï¼ˆè©±é€Ÿï¼‰ã‚’èª¿æ•´ã—ã¾ã™ã€‚</div>
        </div>
        <!-- Preset area removed -->
      </div>
    </div>

    <div class="main-content">
      <div class="visual-area">
        <img id="main-display-img" src="" alt="Scene">
        <div class="guide-board">
          <span><span class="key-badge">Enter</span> ã¡ã‚‡ã£ã¨å¾…ã¦ã„ï¼</span>
          <span><span class="key-badge">Shift</span> ã‚¤ãƒ©ã‚¤ãƒ©ã—ãŸæ™‚</span>
        </div>
      </div>
      <div class="chat-area">
        <div id="chat-log" class="chat-log"></div>
        <div class="input-area">
          <button id="btn-mic" class="icon-btn" title="éŸ³å£°å…¥åŠ›">
            <svg class="svg-icon" viewBox="0 0 24 24">
              <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
              <path
                d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
            </svg>
          </button>
          <input type="text" id="text-input" placeholder="Ctrl + Enter ã§é€ä¿¡ (ã¾ãŸã¯Enterã§ã€å¾…ã¦ã„ï¼ã€)">
          <button id="btn-send" class="icon-btn" title="é€ä¿¡">
            <svg class="svg-icon" viewBox="0 0 24 24">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
            </svg>
          </button>
          <label style="margin-left:10px; font-size:0.85rem; color:#666; cursor:pointer;">
            <input type="checkbox" id="chk-tts" checked> éŸ³å£°ON
          </label>
        </div>
      </div>
    </div>
  </div>

  <div id="end-modal">
    <div class="modal-content">
      <div class="modal-title">ã¡ã‚‡ã£ã¨å¾…ã£ã¦ï¼</div>
      <p class="modal-text">
        ç¾å®Ÿã®ä¼šè©±ã§ã¯ã€Œçµ‚äº†ãƒœã‚¿ãƒ³ã€ã‚’æŠ¼ã—ã¦çµ‚ã‚ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚<br>
        <b>ç›¸æ‰‹ã®ã“ã¨ã‚’æ€ã„ã‚„ã£ã¦ã€ä¼šè©±ã‚’çµ‚ã‚ã‚‰ã›ã‚‹è¨€è‘‰</b>ã‚’ä¼ãˆã¦ã‹ã‚‰çµ‚äº†ã—ã¾ã—ã‚‡ã†ã€‚
      </p>
      <input type="text" id="end-input" class="modal-input" placeholder="ä¾‹ï¼šãã‚ãã‚å¸°ã‚‹ã­ã€ã¾ãŸæ¥ã‚‹ã‚ˆï¼">
      <button class="btn" onclick="sendEndMessage()">ä¼ãˆã¦çµ‚äº†ã™ã‚‹</button>
      <button class="btn btn-outline" style="margin-left:10px;" onclick="closeEndModal()">ã¾ã ç¶šã‘ã‚‹</button>
    </div>
  </div>

  <div id="page-result">
    <div style="padding:20px; text-align:left;">
      <button class="btn btn-outline" onclick="backToMainFromReview()">â† ä¼šè©±ã«æˆ»ã‚‹</button>
    </div>

    <div class="review-container">
      <div style="text-align:center; margin-bottom:20px;">
        <h2 style="color:#2c3e50; margin-bottom:10px;">ğŸ æŒ¯ã‚Šè¿”ã‚Šã‚¿ã‚¤ãƒ </h2>
        <p>ä¼šè©±ã‚’æŒ¯ã‚Šè¿”ã‚Šã¾ã—ã‚‡ã†ã€‚</p>
      </div>

      <div class="vas-container" style="background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);">
        <h4 style="margin-top:0; color:#555;">å¿ƒã®ä½™è£•åº¦ï¼ˆãƒ¡ãƒ³ã‚¿ãƒ«å¿«é©åº¦ï¼‰</h4>
        <div class="vas-shape-wrapper">
          <div id="vas-shape-layer-static" class="vas-layer"></div>
          <div id="vas-shape-layer2" class="vas-layer"></div>
        </div>
        <div class="vas-slider-wrapper">
          <input type="range" id="vas-slider" min="0" max="100" value="50" oninput="updateVas(this.value)">
          <div class="vas-label"><span>ä¸å¿«ãƒ»ã‚¤ãƒ©ã‚¤ãƒ©</span><span>å¿«é©ãƒ»ç©ã‚„ã‹</span></div>
        </div>
        <h4 style="margin-top:30px; color:#555;">å…·ä½“çš„ãªæ„Ÿæƒ…ã¯ï¼Ÿ(è¤‡æ•°é¸æŠå¯)</h4>
        <div class="emotion-tags" id="emotion-tags"></div>
      </div>

      <div style="text-align:center; margin-top:30px;">
        <p style="font-weight:bold; color:#555;">ğŸ‘‡ é•å’Œæ„Ÿã‚’æ„Ÿã˜ãŸç™ºè¨€ãƒ»æ°—ã«ãªã£ãŸç™ºè¨€ãƒ»ä¸å¿«ã«æ„Ÿã˜ãŸç™ºè¨€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„</p>
      </div>

      <div id="review-list" class="chat-review-list"></div>

      <div style="text-align:center; margin-bottom:150px; margin-top:40px;">
        <button class="btn btn-primary" onclick="analyzeReflection()" id="btn-analyze"
          style="padding:15px 30px; font-size:1.1rem;">
          <svg class="svg-icon" viewBox="0 0 24 24">
            <path
              d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6C7.8 12.16 7 10.63 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z" />
          </svg>
          åˆ†æçµæœã‚’è¦‹ã‚‹
        </button>
      </div>
    </div>
  </div>

  <div id="page-analysis">
    <div class="analysis-box">
      <div class="analysis-title">
        <svg class="svg-icon" viewBox="0 0 24 24">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
        </svg>
        ã‚ãªãŸã¸ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹
      </div>

      <div id="analysis-loading" class="loading-anim">
        <div class="loader-wrapper">
          <div class="pulse-circle"></div>
          <div class="pulse-circle"></div>
          <div class="loader-core">ğŸ§ </div>
        </div>
        <p id="loading-text"
          style="color:#666; margin-top:20px; font-weight:bold; font-size:1.1rem; text-shadow:0 1px 1px white;">
          ä¼šè©±ãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...</p>
      </div>

      <div id="comparison-area"
        style="display:none; margin-top:30px; border-top:1px solid rgba(0,0,0,0.1); padding-top:20px;">
        <h3 style="color:#555;">ğŸ“Š ã¿ã‚“ãªã®ä½“é¨“ãƒ‡ãƒ¼ã‚¿ã¨ã®æ¯”è¼ƒ</h3>
        <div style="font-size:0.85rem; color:#666; margin-bottom:15px;">
          ã‚ãªãŸã®ã‚¹ã‚³ã‚¢ã¨ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆã¾ãŸã¯å¹³å‡ï¼‰ã‚’æ¯”è¼ƒã—ã¦ã€è‡ªåˆ†ã®å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å®¢è¦³çš„ã«è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
        </div>

        <div class="analysis-flex"
          style="display:flex; flex-wrap:wrap; gap:20px; justify-content:space-between; margin-top:20px;">
          <!-- Move text here as requested -->
          <div style="flex: 1 1 100%; order: -1; margin-bottom: 20px;">
            <div id="insight-text" class="insight-text">åˆ†æä¸­...</div>
            <div id="insight-sub" class="insight-sub">ã‚ãªãŸã®è¨­å®šã«åŸºã¥ã„ãŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚</div>
          </div>

          <div class="chart-section" style="flex:1 1 300px; max-width:500px; height:450px; position:relative;">
            <div style="text-align:center; font-weight:bold; margin-bottom:10px; color:#555;">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®šæ¯”è¼ƒ</div>
            <canvas id="radarChart"></canvas>
          </div>
          <div class="insight-section" style="flex:1 1 300px; min-width:300px;">
            <div class="ranking-table-container"
              style="margin:20px 0; padding:15px; border-radius:12px; background:rgba(255,255,255,0.7);">
              <div id="ranking-title"
                style="font-size:0.9rem; font-weight:bold; margin-bottom:15px; color:#666; cursor:pointer; user-select:none;"
                onclick="toggleDevMode()">ã‚¹ã‚³ã‚¢ãƒ©ãƒ³ã‚­ãƒ³ã‚°
              </div>
              <table class="ranking-table">
                <thead>
                  <tr>
                    <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼<span style="font-size:0.7rem; font-weight:normal; margin-left:5px;">(ã‚¯ãƒªãƒƒã‚¯ã§æ¯”è¼ƒ)</span></th>
                    <th>å¿ƒã®ä½™è£•åº¦</th>
                    <th>å¾…ã¦ã„!</th>
                    <th>ã‚¤ãƒ©ã‚¤ãƒ©</th>
                  </tr>
                </thead>
                <tbody id="ranking-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div id="analysis-content" class="analysis-content" style="display:none; margin-bottom:40px;"></div>

      <div style="text-align:center; margin-top:40px; margin-bottom:20px; padding:20px;">
        <button class="btn btn-outline" onclick="location.reload()"
          style="border-radius:30px; padding:12px 30px;">ã‚‚ã†ä¸€åº¦ã°ã‚ã°ã¨è©±ã™</button>
      </div>
    </div>
  </div>

  <script>
    // (JSãƒ­ã‚¸ãƒƒã‚¯ã¯å‰å›ã¨åŒã˜ã§ã™ãŒã€å¿µã®ãŸã‚å…¨ã¦è¨˜è¿°)
    const SCENARIOS = [
      { title: 'ç¥–æ¯ã®å®¶', name: 'ãŠã°ã‚ã¡ã‚ƒã‚“', img: '/public/image/granma_kotatsu.jpg', description: 'ã‚ãªãŸã¯ä¹…ã—ã¶ã‚Šã«è¨ªã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¥–æ¯ã€ŒãŠã°ã‚ã¡ã‚ƒã‚“ã€ã§ã™ã€‚å­«ãŒè¨ªã‚Œã¦ãã‚Œã¾ã—ãŸã€‚ã‚ãªãŸã¯ç©æ¥µçš„ã«è³ªå•ã‚’ã—ã¦ã€ä¼šè©±ã‚’åºƒã’ã‚ˆã†ã¨ã—ã¦ãã ã•ã„ã€‚', guide: 'ä¹…ã—ã¶ã‚Šã«ç¥–æ¯ã®å®¶ã«éŠã³ã«æ¥ã¾ã—ãŸã€‚è¿‘æ³å ±å‘Šã‚’ã—ã¾ã—ã‚‡ã†ã€‚' },
      { title: 'ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹', name: 'å’Œå­ã•ã‚“', img: '/public/image/granma_dayservice.jpg', description: 'ã‚ãªãŸã¯é€±ï¼’ã§ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ã«é€šã£ã¦ã„ã‚‹ã€Œå’Œå­ï¼ˆã‹ãšã“ï¼‰ã•ã‚“ã€ã¨ã„ã†ãŠã—ã‚ƒã¹ã‚Šãªé«˜é½¢è€…ã§ã™ã€‚å¤§å­¦ç”ŸãŒå®Ÿç¿’ã«æ¥ãŸã®ã§ã€ãƒã‚·ãƒ³ã‚¬ãƒ³ãƒˆãƒ¼ã‚¯ã§ä¸€æ–¹çš„ã«è©±ã—ã‹ã‘ã¦ãã ã•ã„ã€‚', guide: 'ã‚ãªãŸã¯å¤§å­¦ã®å®Ÿç¿’ã§ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ã¦ã„ã¾ã™ã€‚é€±ã«ï¼’å›é€šã£ã¦ã„ã‚‹éš£ã®å¸­ã®å’Œå­ã•ã‚“ãŒä½•ã‹ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚ä½•ã‚’ã—ã¦ã„ã‚‹ã‹èã„ã¦ã¿ã¾ã—ã‚‡ã†ã€‚' },
      { title: 'é§…ã®æ”¹æœ­å‘¨è¾º', name: 'ãŠã°ã‚ã•ã‚“', img: '/public/image/granma_station.jpg', description: 'ã‚ãªãŸã¯åœ°æ–¹ã‹ã‚‰å­«ã«ä¼šã„ã«æ¥ãŸã€ŒãŠã°ã‚ã•ã‚“ã€ã§ã™ã€‚ãƒã‚¹ã§ã‚¿ãƒ¼ãƒŸãƒŠãƒ«é§…ã¾ã§ã¯æ¥ã‚Œã¾ã—ãŸãŒã€é§…ãŒè¤‡é›‘ã§å­«ã®æœ€å¯„ã‚Šã¸ã®è¡Œãæ–¹ãŒã‚ã‹ã‚‰ãšå›°æƒ‘ã—ã¦ã„ã¾ã™ã€‚å£°ã‚’ã‹ã‘ã¦ãã‚ŒãŸè‹¥è€…ã«ã¯ã€ã€Œå„ªã—ã„ã‚ã­ã€œã€ã¨æ„Ÿè¬ã‚’ä¼ãˆã¦ãã ã•ã„ã€‚', guide: 'é§…ã§å›°ã£ã¦ã„ã‚‹ãŠå¹´å¯„ã‚ŠãŒã„ã¾ã™ã€‚å£°ã‚’ã‹ã‘ã¦åŠ©ã‘ã¦ã‚ã’ã¾ã—ã‚‡ã†ã€‚' },
      { title: 'è€äººãƒ›ãƒ¼ãƒ ', name: 'æ¸…ã•ã‚“', img: '/public/image/granpa_home.jpg', description: 'ã‚ãªãŸã¯è€äººãƒ›ãƒ¼ãƒ ã«å…¥å±…ã—ã¦ã„ã‚‹ã€Œæ¸…ï¼ˆãã‚ˆã—ï¼‰ã•ã‚“ã€ã¨ã„ã†ç„¡å£ã§å¯¡é»™ãªç”·æ€§ã§ã™ã€‚å¤§å­¦ç”ŸãŒå®Ÿç¿’ã§è©±ã—ã‹ã‘ã¦ãã¾ã™ãŒã€ãã£ã‘ãªã„è¿”ç­”ã‚’ã—ã¦ãã ã•ã„ã€‚ä¼šè©±ã‚’åºƒã’ã‚ˆã†ã¨ã¯ã›ãšã€èã‹ã‚ŒãŸã“ã¨ã ã‘ã«çŸ­ãç­”ãˆã¦ãã ã•ã„ã€‚', guide: 'å®Ÿç¿’ã§è¨ªã‚ŒãŸè€äººãƒ›ãƒ¼ãƒ ã€‚ä¸€äººé™ã‹ã«éã”ã™æ¸…ã•ã‚“ã€‚å£æ•°ã¯å°‘ãªã„ã§ã™ãŒã€è¶£å‘³ã‚„æ˜”ã®è©±ã‚’èã„ã¦ä¼šè©±ã‚’åºƒã’ã¦ã¿ã¾ã—ã‚‡ã†ã€‚' }
    ];
    let currentIdx = 0;
    let currentUserName = "";
    let chatHistory = [];
    let aiSpeakingQueue = [];
    let isAiSpeaking = false;
    let stressCount = 0;
    let isPaused = false;
    let pauseCount = 0;
    let currentSpeakingMsg = null;

    const el = id => document.getElementById(id);
    const subSliders = ['forget_ratio', 'repeat_ratio', 'kosoado_ratio', 'summary_skill', 'association_skill'];
    const allParams = ['uen_level', ...subSliders, 'speech_rate']; // Removed filler_ratio
    const EMOTIONS = ["é©šå˜†", "èˆˆå¥®", "é©šã", "æƒ…ç†±", "å¹¸ã›", "æ¥½ã—ã„", "å‹‡æ•¢", "èª‡ã‚Š", "è‡ªä¿¡", "å¸Œæœ›", "æ„‰å¿«", "æº€è¶³", "å®‰å¿ƒ", "æ„Ÿè¬", "å……è¶³", "å†·é™", "ç©ã‚„ã‹", "é€€å±ˆ", "ç„¡é–¢å¿ƒ", "ç–²ã‚Œ", "å›°æƒ‘", "å¿ƒé…", "ä¸å®‰", "æ‚²ã—ã¿", "å¤±æœ›", "è½èƒ†", "ã‚¤ãƒ©ã‚¤ãƒ©", "æ€’ã‚Š", "æ†¤æ…¨"];

    window.onload = () => { initEmotionTags(); updateVas(50); updateUenMeter(); updateDynamicParamImage(); };

    function initEmotionTags() {
      const container = el('emotion-tags');
      EMOTIONS.forEach(emo => {
        const span = document.createElement('span');
        span.className = 'emotion-tag';
        span.textContent = emo;
        span.onclick = () => span.classList.toggle('selected');
        container.appendChild(span);
      });
      // Start VAS loop
      if (!window.vasLoopRunning) {
        window.vasLoopRunning = true;
        vasLoop();
      }
    }

    // VAS (Glass & Morph)
    // VAS Advanced Morphing
    // 7 Stages: 0-100 mapped to specific shapes and colors
    // Shapes: Spiky(8) -> RoundedSpiky -> Wave -> Circle -> Pentagon -> Star -> Flower
    // Colors: Purple -> Blue -> Sky -> Emerald -> YellowGreen -> Yellow -> Orange

    function getVasColor(val) {
      // 0:Purple(#8e44ad) 16:Blue(#2980b9) 33:Sky(#3498db) 50:Emerald(#2ecc71) 
      // 66:YellowGreen(#a2d149) 83:Yellow(#f1c40f) 100:Orange(#e67e22)
      const stops = [
        { t: 0, c: [142, 68, 173] },    // Purple
        { t: 16, c: [41, 128, 185] },   // Blue
        { t: 33, c: [52, 152, 219] },   // Sky
        { t: 50, c: [46, 204, 113] },   // Emerald
        { t: 66, c: [162, 209, 73] },   // YellowGreen
        { t: 83, c: [241, 196, 15] },   // Yellow
        { t: 100, c: [230, 126, 34] }   // Orange
      ];

      // Find range
      let s1 = stops[0], s2 = stops[stops.length - 1];
      for (let i = 0; i < stops.length - 1; i++) {
        if (val >= stops[i].t && val <= stops[i + 1].t) {
          s1 = stops[i]; s2 = stops[i + 1]; break;
        }
      }
      const r = (val - s1.t) / (s2.t - s1.t);
      const c = s1.c.map((v, i) => Math.round(v + (s2.c[i] - v) * r));
      return `rgb(${c[0]}, ${c[1]}, ${c[2]})`;
    }

    // VAS (Glass & Morph)
    function getPolygonPoints(val) {
      // 80 points (LCM of 8 and 5 is 40, 80 is better for curve resolution)
      const N = 80;
      const points = [];

      // 0-50: 8-point Spike -> Circle
      // 50-100: Circle -> 5-point Flower

      const isLower = val <= 50;
      const peaks = isLower ? 8 : 5;

      // Progress factor for each range
      let p = 0;
      if (isLower) p = 1 - (val / 50); // 1.0 (Spike) -> 0.0 (Circle)
      else p = (val - 50) / 50;       // 0.0 (Circle) -> 1.0 (Flower)

      for (let i = 0; i < N; i++) {
        const theta = (i / N) * Math.PI * 2;
        const sinVal = Math.sin(peaks * theta - Math.PI / 2); // Phase align

        // Base radius 35% of box (Reduced from 40% to fit in rotate)
        const baseR = 35;

        let amp = 0;
        let wave = 0;

        if (isLower) {
          // Spike Logic (Sharp star)
          // Need to ensure Val 0 is Spiky.

          // Use power of sine for sharpness
          // 8 peaks

          // p goes 1.0 (val 0) -> 0.0 (val 50)
          // amp should be high at 0.

          amp = 15 * p; // Max amp 15.

          // Sharp wave function
          // sign(sin) * abs(sin)^0.5
          wave = Math.sign(Math.sin(peaks * theta)) * Math.pow(Math.abs(Math.sin(peaks * theta)), 0.5);

          // Force sharp spikes at val 0
          if (p > 0.9) {
            // Extra sharpness check
            // wave is already sharp
          }
        } else {
          // Flower Logic (Smooth petals)
          // r = base + amp * cos(5*theta)
          wave = Math.cos(peaks * theta);
          amp = 10 * p; // Amplitude grows from 0
        }

        // Radius calculation
        const r = baseR + amp * wave;

        // Convert to %
        const x = 50 + r * Math.cos(theta);
        const y = 50 + r * Math.sin(theta);
        points.push(`${x.toFixed(1)}% ${y.toFixed(1)}%`);
      }

      return `polygon(${points.join(', ')})`;
    }

    let vasAnimReq;
    function updateVas(valInput) {
      const val = parseFloat(valInput);
      // Logic for Shape update (Clip Path) & Color
      const lStatic = el('vas-shape-layer-static');
      const l2 = el('vas-shape-layer2');

      const poly = getPolygonPoints(val); // Get Main Shape

      const color = getVasColor(val);

      // Static Layer (No Animation, same shape as ripple)
      // Removed radial-gradient base, using solid color for cleaner look as requested
      // or keeping gradient if it matches "Layer 2 style" but static.
      // Layer 2 has just background=color.
      if (lStatic) {
        lStatic.style.background = color;
        lStatic.style.borderRadius = '0';
        lStatic.style.clipPath = poly;
      }

      // Ripple Layer (Same Shape!)
      if (l2) {
        l2.style.background = color;
        l2.style.borderRadius = '0';
        l2.style.clipPath = poly;
      }

      if (!window.vasLoopRunning) {
        // No loop needed for poly update as it's static per value, 
        // BUT ripple is CSS animation.
        // However, if we change shape, we need to update clip-path.
        // Since input updates this, we are good.
        // If we want "breathing" shape change independent of input, we need loop.
        // Current instruction: "Ripple expands along outer shape".
        // CSS animation handles transform scale. Shape is defined by clip-path.
        // If shape is static (val doesn't change), clip-path is static.
        // Ripple should work.
      }
      // window.currentVasVal = val; // Not really needed if no active loop modifying shape
    }

    function vasLoop() {
      const val = window.currentVasVal || 50;
      const poly = getPolygonPoints(val);
      const l1 = el('vas-shape-layer1');
      const l2 = el('vas-shape-layer2');

      if (l1 && l2) {
        l1.style.clipPath = poly;
        // Background rotation for wave effect
        // Actually getPolygonPoints already includes "pulse" based on Date.now()
        // We just need to apply it.
      }
      if (window.vasLoopRunning) requestAnimationFrame(vasLoop);
    }

    function applyPreset(type) {
      let settings = {};
      if (type === 'basic') settings = { uen_level: 5, forget_ratio: 2, repeat_ratio: 1, kosoado_ratio: 3, summary_skill: 3, association_skill: 3, filler_ratio: 3, speech_rate: 1.2 };
      else if (type === 'forget') settings = { uen_level: 8, forget_ratio: 10, repeat_ratio: 8, kosoado_ratio: 10, summary_skill: 5, association_skill: 2, filler_ratio: 5, speech_rate: 0.9 };
      else if (type === 'chaos') settings = { uen_level: 9, forget_ratio: 6, repeat_ratio: 6, kosoado_ratio: 5, summary_skill: 10, association_skill: 10, filler_ratio: 4, speech_rate: 1.0 };
      Object.keys(settings).forEach(k => { if (el(k)) { el(k).value = settings[k]; updateLabels(k); } });
      updateUenMeter(); // Update meter after preset
      alert('ãŠæ‰‹æœ¬è¨­å®šã‚’é©ç”¨ã—ã¾ã—ãŸ');
    }
    function toggleSidebar() { const s = el('sidebar-panel'); s.classList.toggle('hidden'); }
    function selectInitialScenario(idx) { document.querySelectorAll('.scenario-card').forEach(e => e.classList.remove('selected')); document.querySelectorAll('.scenario-card')[idx].classList.add('selected'); currentIdx = idx; }
    function startWorkshop() {
      const name = el('user-name').value;
      if (!name) { alert('ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      currentUserName = name;
      el('page-landing').style.display = 'none';
      el('page-main').style.display = 'flex';
      const s = SCENARIOS[currentIdx];
      el('main-display-img').src = s.img;
      el('mini-scene-img').src = s.img;
      el('mini-scene-title').textContent = s.title;
      el('scenario-desc-area').textContent = s.guide;
      addMessage(s.guide, 'system');
    }
    function changeScenario(dir) {
      currentIdx += dir;
      if (currentIdx < 0) currentIdx = SCENARIOS.length - 1;
      if (currentIdx >= SCENARIOS.length) currentIdx = 0;
      const s = SCENARIOS[currentIdx];
      el('main-display-img').src = s.img;
      el('mini-scene-img').src = s.img;
      el('mini-scene-title').textContent = s.title;
      el('scenario-desc-area').textContent = s.guide;
      el('chat-log').innerHTML = '';
      addMessage(s.guide, 'system');
    }
    function updateLabels(id) {
      const control = el(id);
      const disp = el('val_' + id.replace('_ratio', '').replace('_skill', '').replace('uen_level', 'uen').replace('speech_rate', 'speed'));
      if (control && disp) {
        control.addEventListener('input', (e) => {
          // è©±é€Ÿã®ã¿ç‰¹åˆ¥ãªå‡¦ç† (1.0 - 3.0 ã®float)
          if (id === 'speech_rate') {
            disp.textContent = parseFloat(e.target.value).toFixed(1);
          } else {
            disp.textContent = e.target.value;
          }
        });
        // åˆæœŸè¡¨ç¤ºæ›´æ–°
        if (id === 'speech_rate') {
          disp.textContent = parseFloat(control.value).toFixed(1);
        } else {
          disp.textContent = control.value;
        }
      }
    }

    function updateUenMeter() {
      const t = subSliders.reduce((s, k) => s + parseInt(el(k).value), 0);
      const avg = Math.round(t / subSliders.length);
      el('val_uen').textContent = avg;
      if (el('uen_meter')) el('uen_meter').style.width = (avg * 10) + '%';
      return avg;
    }

    // Dynamic Parameter Image Text Logic
    function updateDynamicParamImage() {
      // Calculate scores based on sliders
      const forget = parseInt(el('forget_ratio').value);
      const repeat = parseInt(el('repeat_ratio').value);
      const kosoado = parseInt(el('kosoado_ratio').value);
      const summary = parseInt(el('summary_skill').value);
      const assoc = parseInt(el('association_skill').value);

      let text = "ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‹•ã‹ã—ã¦ã€ã°ã‚ã°ã®æ§˜å­ã‚’æƒ³åƒã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚";

      // Priority Logic for combined states (Composite Params)
      if (forget >= 7 && repeat >= 7) {
        text = "ã•ã£ãè©±ã—ãŸã“ã¨ã‚‚å¿˜ã‚Œã¦ã€åŒã˜è©±ã‚’ç¹°ã‚Šè¿”ã—ã¦ã—ã¾ã†ã‹ã‚‚â€¦";
      } else if (summary >= 7 && assoc >= 7) {
        text = "è©±ãŒè„±ç·šã—ã¦ã€ã‚ã£ã¡ã“ã£ã¡é£›ã³ç«ã—ã¦ã€ä½•ã®è©±ã‹åˆ†ã‹ã‚‰ãªããªã‚‹ã‹ã‚‚â€¦";
      } else if (kosoado >= 8 && summary >= 7) {
        text = "ã€Œã‚ã‚Œã€ã€Œãã‚Œã€ãŒå¤šãã¦ã€ã—ã‹ã‚‚å›ã‚Šãã©ã„è©±ã—æ–¹ã«ãªã‚Šãã†ã€‚";
      } else if (forget >= 8 && kosoado >= 8) {
        text = "å¤§äº‹ãªã“ã¨ã‚‚å¿˜ã‚Œã‚‹ã—ã€è¨€è‘‰ã‚‚ãªã‹ãªã‹å‡ºã¦ã“ãªã„ã‹ã‚‚â€¦";
      } else if (summary >= 8) {
        text = "å‰ç½®ããŒé•·ãã¦ã€çµå±€ä½•ãŒè¨€ã„ãŸã„ã®ã‹åˆ†ã‹ã‚‰ãªã„ã‹ã‚‚â€¦";
      } else if (assoc >= 8) {
        text = "ä¸€ã¤ã®å˜èªã‹ã‚‰é€£æƒ³ã—ã¦ã€ã©ã‚“ã©ã‚“è©±é¡ŒãŒå¤‰ã‚ã£ã¡ã‚ƒã†ã‹ã‚‚ï¼";
      } else if (kosoado >= 8) {
        text = "ã€Œã‚ã‚Œã€ã€Œãã‚Œã€ã°ã‹ã‚Šã§ã€ä½•ã®è©±ã‹åˆ†ã‹ã‚‰ãªã„ã‹ã‚‚ï¼Ÿ";
      } else if (repeat >= 8) {
        text = "åŒã˜ã“ã¨ã‚’ä½•åº¦ã‚‚ä½•åº¦ã‚‚ç¹°ã‚Šè¿”ã—ã¦è©±ã—ã¦ã—ã¾ã†ã‹ã‚‚ã€‚";
      } else if (forget >= 7) {
        text = "å¤§åˆ‡ãªã“ã¨ã‚‚ã€ã™ãã«å¿˜ã‚Œã¡ã‚ƒã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚";
      }

      el('param-dynamic-image').textContent = text;
    }

    // el('uen_level').oninput removed as it's now a meter
    subSliders.forEach(id => { el(id).oninput = e => { updateLabels(id); updateUenMeter(); updateDynamicParamImage(); } });
    el('speech_rate').oninput = e => updateLabels('speech_rate');

    // Preset functions removed per Round 10 feedback

    let recognizer, synthesizer;
    async function initSpeechSDK() {
      if (!window.SpeechSDK) { alert('SDK Error'); return false; }
      if (recognizer) return true;
      try {
        const res = await fetch('/api/speech-token'); if (!res.ok) throw new Error(await res.text());
        const tokenObj = await res.json();
        const sc = SpeechSDK.SpeechConfig.fromAuthorizationToken(tokenObj.token, tokenObj.region);
        sc.speechRecognitionLanguage = 'ja-JP'; sc.speechSynthesisLanguage = 'ja-JP'; sc.speechSynthesisVoiceName = 'ja-JP-NanamiNeural';
        recognizer = new SpeechSDK.SpeechRecognizer(sc, SpeechSDK.AudioConfig.fromDefaultMicrophoneInput());
        synthesizer = new SpeechSDK.SpeechSynthesizer(sc, SpeechSDK.AudioConfig.fromSpeakerOutput());
        recognizer.recognized = (s, e) => { if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech && e.result.text) { el('text-input').value = e.result.text; sendMessage(); } };
        return true;
      } catch (e) { console.error(e); alert("éŸ³å£°æ©Ÿèƒ½ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); return false; }
    }
    el('btn-mic').onclick = async () => { if (await initSpeechSDK()) { try { recognizer.startContinuousRecognitionAsync(); el('btn-mic').classList.add('active'); } catch (e) { } } };

    // Button Click Fix (SVG click issue)
    el('btn-send').onclick = () => sendMessage();

    // Stress Logic Update
    let shiftPressCount = 0;
    let shiftResetTimer = null;
    let lastShiftTime = 0;

    document.addEventListener('keydown', (e) => {
      const now = Date.now();
      if (e.key === 'Enter' && isAiSpeaking) {
        e.preventDefault();
        isPaused = !isPaused;
        if (isPaused) {
          pauseCount++;
          el('wait-overlay').style.display = 'flex';
          if (currentSpeakingMsg) {
            if (!currentSpeakingMsg.events) currentSpeakingMsg.events = [];
            currentSpeakingMsg.events.push({ type: 'wait', text: "ğŸ›‘ ã¡ã‚‡ã£ã¨å¾…ã¦ã„ï¼" });
          }
        } else {
          el('wait-overlay').style.display = 'none';
        }
        return;
      }
      if (e.key === 'Shift' && isAiSpeaking && !isPaused) {
        if (now - lastShiftTime > 2000) {
          // 2ç§’ä»¥ä¸Šç©ºã„ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
          shiftPressCount = 0;
          document.getElementById('stress-overlay').style.opacity = 0;
        }
        lastShiftTime = now;
        shiftPressCount++;
        stressCount++; // ç·æ•°ã¯ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹

        // 3å›ã§MAXè­¦å‘Š
        const maxCount = 3;
        const opacity = Math.min(shiftPressCount / maxCount, 1.0);
        document.getElementById('stress-overlay').style.opacity = opacity;

        if (shiftPressCount >= maxCount) {
          el('stress-warning').classList.add('show');
          if (currentSpeakingMsg) {
            if (!currentSpeakingMsg.events) currentSpeakingMsg.events = [];
            const has = currentSpeakingMsg.events.some(ev => ev.type === 'stress');
            if (!has) currentSpeakingMsg.events.push({ type: 'stress', text: "ğŸ’¢ ã‚¤ãƒ©ã‚¤ãƒ©é€£æ‰“ï¼" });
          }
        }

        // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
        if (shiftResetTimer) clearTimeout(shiftResetTimer);
        shiftResetTimer = setTimeout(() => {
          document.getElementById('stress-overlay').style.opacity = 0;
          el('stress-warning').classList.remove('show');
          shiftPressCount = 0; // è¡¨ç¤ºãŒæ¶ˆãˆãŸã‚‰ã‚«ã‚¦ãƒ³ãƒˆã‚‚ãƒªã‚»ãƒƒãƒˆï¼ˆé€£æ‰“ç¶™ç¶šåˆ¤å®šã®ãŸã‚ï¼‰
        }, 2000);
      }
    });

    async function sendMessage(manualText = null) {
      const text = manualText || el('text-input').value.trim();
      if (!text) return;
      if (isAiSpeaking) { aiSpeakingQueue = []; isAiSpeaking = false; }
      addMessage(text, 'user');
      chatHistory.push({ role: 'user', text: text, id: Date.now() });
      if (!manualText) el('text-input').value = '';

      const loadingId = 'loading-' + Date.now();
      showLoading(loadingId);
      const uen = parseInt(el('val_uen').textContent);
      const targetSentences = Math.max(3, Math.ceil(uen * 1.5));
      const inputs = {
        user_name: currentUserName,
        scenario: SCENARIOS[currentIdx].description,
        target_sentences: targetSentences,
        uen_level: uen,
        forget_ratio: el('forget_ratio').value,
        repeat_ratio: el('repeat_ratio').value,
        kosoado_ratio: el('kosoado_ratio').value,
        summary_skill: el('summary_skill').value,
        association_skill: el('association_skill').value
      };
      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, inputs, userId: currentUserName + "_123", history: chatHistory })
        });
        const data = await res.json();
        const reply = data.answer || "ï¼ˆå¿œç­”ãªã—ï¼‰";
        removeLoading(loadingId);
        chatHistory.push({ role: 'ai', text: reply });
        const rawSegments = splitTextSmart(reply);
        aiSpeakingQueue = [];
        rawSegments.forEach(seg => { aiSpeakingQueue.push({ text: seg, role: 'ai', id: Date.now() + Math.random() }); });
        await processAiSpeakingQueue();
      } catch (e) {
        removeLoading(loadingId);
        addMessage(`ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'system');
      }
    }

    async function processAiSpeakingQueue() {
      isAiSpeaking = true;
      const speedRate = parseFloat(el('speech_rate').value) || 1.0;
      while (aiSpeakingQueue.length > 0) {
        while (isPaused) { await new Promise(r => setTimeout(r, 200)); if (!isAiSpeaking) break; }
        if (!isAiSpeaking) break;

        const segObj = aiSpeakingQueue.shift();
        currentSpeakingMsg = segObj;
        chatHistory.push(segObj);
        const match = segObj.text.match(/^\[(.*?)\](.*)/s);
        let tag = ""; let content = segObj.text;
        if (match) { tag = match[1]; content = match[2]; }
        addMessage(content, 'ai', tag);

        if (el('chk-tts').checked) {
          if (!synthesizer) await initSpeechSDK();
          if (synthesizer) {
            const pitch = "-15%";
            const ssml = `<speak version="1.0" xml:lang="ja-JP"><voice name="ja-JP-NanamiNeural"><prosody rate="${speedRate}" pitch="${pitch}">${content}</prosody></voice></speak>`;
            synthesizer.speakSsmlAsync(ssml);
          }
        }
        const waitTime = (content.length * 250 / speedRate) + 500;
        await new Promise(resolve => setTimeout(resolve, waitTime));
      }
      isAiSpeaking = false;
      currentSpeakingMsg = null;
      document.getElementById('stress-overlay').style.opacity = 0;
      stressCount = 0;
    }

    function splitTextSmart(text) { return text.split('\n').filter(s => s.trim() !== ""); }
    function addMessage(text, role, tag = null) {
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      // Strip tags for display
      const cleanText = text.replace(/\[.*?\]/g, "");
      div.textContent = cleanText;
      el('chat-log').appendChild(div);
      el('chat-log').scrollTop = el('chat-log').scrollHeight;
    }
    function showLoading(id) {
      const div = document.createElement('div');
      div.id = id; div.className = 'msg thinking';
      div.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
      el('chat-log').appendChild(div);
      el('chat-log').scrollTop = el('chat-log').scrollHeight;
    }
    function removeLoading(id) { const e = document.getElementById(id); if (e) e.remove(); }

    function showEndModal() { el('end-modal').style.display = 'flex'; }
    function closeEndModal() { el('end-modal').style.display = 'none'; }
    async function sendEndMessage() {
      const endText = el('end-input').value;
      if (!endText) { alert("æœ€å¾Œã®è¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      closeEndModal();
      await sendMessage(endText);
      setTimeout(() => {
        el('page-main').style.display = 'none';
        el('page-result').style.display = 'block';
        renderReviewList();
      }, 2000);
    }
    function backToMainFromReview() { el('page-result').style.display = 'none'; el('page-main').style.display = 'flex'; }
    function backToMain() { el('page-analysis').style.display = 'none'; el('page-main').style.display = 'flex'; }

    function renderReviewList() {
      const listEl = el('review-list');
      listEl.innerHTML = '';
      chatHistory.forEach((item) => {
        const div = document.createElement('div');
        div.className = `review-item ${item.role}`;
        if (item.role === 'ai') {
          if (!item.id) return;
          const match = item.text.match(/^\[(.*?)\](.*)/s);
          let content = item.text; if (match) content = match[2];
          let eventHtml = "";
          if (item.events) {
            item.events.forEach(ev => {
              const styleClass = ev.type === 'wait' ? 'wait' : 'stress';
              eventHtml += `<div class="event-log ${styleClass}">${ev.text}</div>`;
            });
          }
          div.innerHTML = `<div style="flex:1;"><div class="review-role">${SCENARIOS[currentIdx].name}</div>${eventHtml}<div style="display:flex; gap:10px; margin-bottom:8px; align-items:flex-start; cursor:pointer;" onclick="this.querySelector('.review-checkbox').click()"><input type="checkbox" class="review-checkbox" value="${content}" onclick="event.stopPropagation()"><span class="review-text" style="display:inline-block; padding:5px;">${content}</span></div></div>`;
        } else {
          if (!item.id) return;
          div.innerHTML = `<div style="flex:1; text-align:right;"><div class="review-role">ã‚ãªãŸ</div><div class="review-text" style="background:#eef2ff; padding:8px 12px; border-radius:12px; display:inline-block;">${item.text}</div></div>`;
        }
        listEl.appendChild(div);
      });
    }

    // åˆ†ææ©Ÿèƒ½
    let loadInterval; // Declare loadInterval globally or in a scope accessible by clearInterval

    async function analyzeReflection() {
      const vasVal = el('vas-slider').value;
      const selectedEmotions = Array.from(document.querySelectorAll('.emotion-tag.selected')).map(e => e.textContent);
      const checkboxes = document.querySelectorAll('.review-checkbox:checked');
      const selectedQuotes = [];
      checkboxes.forEach(cb => selectedQuotes.push("ãƒ»" + cb.value));

      el('page-result').style.display = 'none';
      el('page-analysis').style.display = 'block';
      el('analysis-loading').style.display = 'flex';
      el('analysis-content').style.display = 'none';
      el('comparison-area').style.display = 'none';

      // Loading Text Animation
      const msgs = ["éŸ³å£°ç‰¹å¾´é‡ã‚’æŠ½å‡ºä¸­...", "æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨ˆç®—ä¸­...", "é¡ä¼¼ã‚±ãƒ¼ã‚¹ã¨æ¯”è¼ƒä¸­...", "ã‚ãªãŸã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç”Ÿæˆä¸­..."];
      let msgIdx = 0;
      loadInterval = setInterval(() => {
        msgIdx = (msgIdx + 1) % msgs.length;
        el('loading-text').textContent = msgs[msgIdx];
      }, 1500);

      const params = [
        `ç·åˆ:${el('val_uen').textContent}`, `ç‰©å¿˜ã‚Œ:${el('forget_ratio').value}`, `ç¹°ã‚Šè¿”ã—:${el('repeat_ratio').value}`,
        `è¨€è‘‰è©°ã¾ã‚Š:${el('kosoado_ratio').value}`, `å›ã‚Šãã©ã•:${el('summary_skill').value}`, `è„±ç·š:${el('association_skill').value}`
      ].join(", ");

      const difyInputs = {
        selected_quotes: selectedQuotes.join("\n") || "ï¼ˆç‰¹ã«ãªã—ï¼‰",
        parameters: params,
        scenario: SCENARIOS[currentIdx].title,
        stress_count: stressCount,
        pause_count: pauseCount,
        vas_value: parseInt(vasVal),
        emotion_tags: selectedEmotions.join(", ") || "ç‰¹ã«ãªã—",
        user_name: currentUserName
      };

      const analysisPrompt = `ã€ã‚·ã‚¹ãƒ†ãƒ æŒ‡ä»¤: åˆ†æãƒ¢ãƒ¼ãƒ‰ã€‘ãƒ¦ãƒ¼ã‚¶ãƒ¼å:${currentUserName} [æ„Ÿæƒ…]å¿«/ä¸å¿«:${vasVal} [ãƒ‡ãƒ¼ã‚¿]ã‚¤ãƒ©ã‚¤ãƒ©:${stressCount}å›,å¾…ã¦ã„:${pauseCount}å› [ç™ºè¨€]${difyInputs.selected_quotes}ã€é‡è¦ã€‘ãƒ†ã‚­ã‚¹ãƒˆã¯ç¾åœ¨ã®70%ç¨‹åº¦ã®é‡ã«æŠ‘ãˆã€ç°¡æ½”ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚ã€ŒVASå€¤ã€ã¨ã„ã†è¨€è‘‰ã¯ä½¿ã‚ãšã€Œå¿ƒã®ä½™è£•åº¦ã€ã¨ã—ã¦ãã ã•ã„ã€‚`;

      try {
        const res = await fetch('/api/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text: analysisPrompt, inputs: difyInputs, userId: "analysis_" + Date.now() }) });
        const data = await res.json();
        let resultText = data.answer;
        if (!resultText || resultText === "{}") resultText = "åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸã€‚";

        clearInterval(loadInterval);
        el('analysis-loading').style.display = 'none';
        el('analysis-content').style.display = 'block';
        el('analysis-content').innerHTML = marked.parse(resultText);
        el('insight-text').style.display = 'none'; // Hide "Analyzing..." text
        el('insight-sub').style.display = 'none';

        // Save history first
        saveToHistory({
          name: currentUserName,
          wait: pauseCount,
          stress: stressCount,
          vas: parseInt(vasVal),
          params: { forget: parseInt(el('forget_ratio').value), repeat: parseInt(el('repeat_ratio').value), kosoado: parseInt(el('kosoado_ratio').value), summary: parseInt(el('summary_skill').value), assoc: parseInt(el('association_skill').value) }
        });

        renderComparison(difyInputs);
      } catch (e) {
        el('analysis-content').textContent = "ã‚¨ãƒ©ãƒ¼: " + e.message;
      }
    }

    // æ¯”è¼ƒã‚°ãƒ©ãƒ• (Mock Data)
    function generateMockUsers() {
      const users = []; const names = ["Aã•ã‚“", "Bã•ã‚“", "Cã•ã‚“", "Dã•ã‚“", "Eã•ã‚“"];
      names.forEach(name => {
        const uen = Math.floor(Math.random() * 10) + 1;
        users.push({
          name: name,
          wait: Math.floor(Math.random() * 3),
          stress: Math.floor(Math.random() * (uen * 0.8)),
          vas: Math.floor(100 - (uen * 5) - Math.random() * 20), // ä½™è£•åº¦
          params: { forget: Math.random() * 10, repeat: Math.random() * 10, kosoado: Math.random() * 10, summary: Math.random() * 10, assoc: Math.random() * 10 }
        });
      });
      return users;
    }
    let isDevMode = false;
    let devModeCount = 0;

    function toggleDevMode() {
      devModeCount++;
      if (devModeCount >= 5) {
        isDevMode = !isDevMode;
        devModeCount = 0;
        alert(isDevMode ? "Debug Mode: ON (Mock Data)" : "Debug Mode: OFF (Recent History)");
        // Re-render if analysis box is shown
        if (el('comparison-area').style.display === 'block') {
          // Trigger re-render... might need to pass data.
          // Ideally renderComparison() reads global or passed data.
          // For now, prompt user to re-analyze or just knowing it will apply next time.
          // Let's try to reload chart if possible.
          const dummyInputs = { pause_count: pauseCount, stress_count: stressCount, vas_value: parseInt(el('vas-slider').value) };
          renderComparison(dummyInputs);
        }
      }
    }

    // Save/Load History
    function saveToHistory(userObj) {
      let history = JSON.parse(localStorage.getItem('senior_sim_history') || "[]");
      // Add new to top
      history.unshift(userObj);
      // Keep max 5
      if (history.length > 5) history.pop();
      localStorage.setItem('senior_sim_history', JSON.stringify(history));
    }

    function getHistoryUsers() {
      let history = JSON.parse(localStorage.getItem('senior_sim_history') || "[]");
      // Convert stored data to user objects expected by renderComparison
      return history.map((h, i) => ({
        name: h.name || `User${i + 1}`,
        wait: h.wait,
        stress: h.stress,
        vas: h.vas,
        params: h.params
      }));
    }

    function renderComparison(mydata) {
      const area = el('comparison-area'); area.style.display = 'block';

      const me = { name: currentUserName + " (ã‚ãªãŸ)", wait: mydata.pause_count, stress: mydata.stress_count, vas: mydata.vas_value, isMe: true, params: { forget: parseInt(el('forget_ratio').value), repeat: parseInt(el('repeat_ratio').value), kosoado: parseInt(el('kosoado_ratio').value), summary: parseInt(el('summary_skill').value), assoc: parseInt(el('association_skill').value) } };

      // Save 'me' to history (if not just re-rendering for toggle)
      // Check if we already saved this session? 
      // Simplified: Just save every time analyzeReflection calls this.
      // But verify if called from Toggle. 
      // Let's assume history contains *previous* sessions.

      let users = [];
      if (isDevMode) {
        users = generateMockUsers();
        users.push(me);
      } else {
        users = getHistoryUsers();
        // Dedupe: Filter out 'me' from history if name matches (handling suffix)
        // Check if history user matches current user (fuzzy match for "(ã‚ãªãŸ)")
        users = users.filter(u => {
          const uName = u.name.replace(" (ã‚ãªãŸ)", "");
          const meName = me.name.replace(" (ã‚ãªãŸ)", "");
          return uName !== meName || u.stress !== me.stress || u.wait !== me.wait;
          // If strict equality of content differs, keep it? 
          // Request says "Duplicate display". If content is same, remove.
          // If name is same but content diff? Maybe different session. 
          // Let's assume name unique per session or just filter identicals.
          // User image shows same name, same stats.
        });
        users.push(me);
      }

      // Sort
      users.sort((a, b) => b.vas - a.vas);

      const tbody = el('ranking-body'); tbody.innerHTML = '';
      users.forEach(u => {
        // Highlight logic
        const uName = u.name.replace(" (ã‚ãªãŸ)", "");
        const meName = me.name.replace(" (ã‚ãªãŸ)", "");
        const isMe = (uName === meName && u.stress === me.stress && u.wait === me.wait) || u.isMe;
        if (isMe) u.isMe = true;

        const tr = document.createElement('tr');
        if (u.isMe) tr.className = 'user-highlight';

        const vasColor = u.vas > 80 ? '#00b894' : (u.vas > 40 ? '#fdcb6e' : '#ff7675');
        const vasHtml = `<div class="capacity-bar-container"><div class="capacity-bar-bg"><div class="capacity-bar-fill" style="width:0%; background:${vasColor};" data-w="${u.vas}"></div></div><div class="capacity-val">${u.vas}</div></div>`;

        tr.innerHTML = `<td>${u.name}</td><td style="width:120px;">${vasHtml}</td><td>${u.wait}å›</td><td>${u.stress}å›</td>`;

        tr.onclick = () => {
          if (!window.myRadarChart) return;
          if (u.isMe) return; // Disable clicking self

          if (tr.classList.contains('selected')) {
            tr.classList.remove('selected');
            removeDataset(u.name);
          } else {
            tr.classList.add('selected');
            addDataset(u);
          }
        };
        tbody.appendChild(tr);
      });

      setTimeout(() => { document.querySelectorAll('.capacity-bar-fill').forEach(b => b.style.width = b.getAttribute('data-w') + '%'); }, 100);

      // ã‚¤ãƒ³ã‚µã‚¤ãƒˆç”Ÿæˆ (å¹³å‡å€¤ã¨ã®æ¯”è¼ƒ)
      const avg = { forget: 5, repeat: 4, kosoado: 6, summary: 5, assoc: 5 };
      // ... (Insight logic unchanged) ...

      // Initial Chart (You + Average)
      const ctx = el('radarChart').getContext('2d');
      if (window.myRadarChart) window.myRadarChart.destroy();

      const datasets = [
        {
          label: 'ã‚ãªãŸ',
          data: [me.params.forget, me.params.repeat, me.params.kosoado, me.params.summary, me.params.assoc],
          backgroundColor: 'rgba(155, 89, 182, 0.5)',
          borderColor: '#8e44ad',
          borderWidth: 3,
          pointBackgroundColor: '#fff'
        },
        {
          label: 'å¹³å‡',
          data: [5, 4, 6, 5, 5],
          backgroundColor: 'rgba(200,200,200,0.1)',
          borderColor: '#bdc3c7',
          borderWidth: 2,
          borderDash: [5, 5],
          pointRadius: 0
        }
      ];

      window.myRadarChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['ç‰©å¿˜ã‚Œ', 'ç¹°ã‚Šè¿”ã—', 'è©°ã¾ã‚Š', 'å›ã‚Šãã©ã•', 'é€£æƒ³åŠ›'],
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { r: { suggestedMin: 0, suggestedMax: 10, ticks: { display: false, stepSize: 2 } } },
          plugins: {
            legend: { position: 'bottom', labels: { boxWidth: 10, padding: 10 } }, // Compact legend
          },
          layout: { padding: { bottom: 20 } } // Add padding for legend
        }
      });
    }

    function addDataset(user) {
      if (!window.myRadarChart) return;
      // Color based on VAS
      let color = '#ff7675'; // default red
      if (user.vas > 80) color = '#00b894';
      else if (user.vas > 40) color = '#fdcb6e';

      const newSet = {
        label: user.name,
        data: [user.params.forget, user.params.repeat, user.params.kosoado, user.params.summary, user.params.assoc],
        backgroundColor: 'transparent',
        borderColor: color,
        borderWidth: 2
      };
      window.myRadarChart.data.datasets.push(newSet);
      window.myRadarChart.update();
    }

    function removeDataset(label) {
      if (!window.myRadarChart) return;
      const idx = window.myRadarChart.data.datasets.findIndex(d => d.label === label);
      if (idx > -1) {
        window.myRadarChart.data.datasets.splice(idx, 1);
        window.myRadarChart.update();
      }
    }
    function getColor(v) { if (v >= 8) return 'high'; if (v >= 4) return 'mid'; return 'low'; }

    el('text-input').addEventListener('keydown', (e) => { if (e.isComposing) return; if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); sendMessage(); } });
  </script>
</body>

</html>
